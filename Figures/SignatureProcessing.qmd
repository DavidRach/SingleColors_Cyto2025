---
title: "Signature Processing With Luciernaga"
format: html
---

Specify plot storage location

```{r}
StorageLocation <- file.path("Figures", "Figure_SignatureProcessing")
```

# Setup

Load required packages via the library call 

```{r}
library(dplyr)
library(flowCore)
library(flowWorkspace)
library(openCyto)
library(Luciernaga)
library(ggplot2)
```

Provide a openCyto gating template
```{r}
FileLocation <- system.file("extdata", package = "Luciernaga")
MyGates <- data.table::fread(file.path(path = FileLocation, pattern = 'Gates.csv'))

removestrings <-  c("(Cells)", ".fcs", " ")
```

Locate the fcs files
```{r}
File_Location <- "/home/david/Desktop/Data_SCs"
FCS_Pattern <- ".fcs$"
FCS_Files <- list.files(path = File_Location, pattern = FCS_Pattern,
                        full.names = TRUE, recursive = FALSE)

SingleColor <- FCS_Files[-grep("Unstained", FCS_Files)]
Unstained <- FCS_Files[grep("Unstained", FCS_Files)]
```

Load Unstained into GatingSet (for simplicity kept separate), gate and plot

```{r}
UnstainedCytoSet <- load_cytoset_from_fcs(Unstained, 
                                   truncate_max_range = FALSE, 
                                   transform = FALSE)
UnstainedGatingSet <- GatingSet(UnstainedCytoSet)

MyGatingTemplate <- gatingTemplate(MyGates)
gt_gating(MyGatingTemplate, UnstainedGatingSet)


UnstainedPlot <- Utility_GatingPlots(x=UnstainedGatingSet, 
                                      sample.name = "GUID", 
                                      removestrings = removestrings, 
                                      gtFile = MyGates, 
                                      DesiredGates = NULL, 
                                      outpath = StorageLocation, 
                                      returnType="patchwork")

UnstainedPlot
```

Load SingleColors into a Gating set (for simplicity kept separate), gate and plot
```{r}
SingleColorCytoSet <- load_cytoset_from_fcs(SingleColor, 
                                   truncate_max_range = FALSE, 
                                   transform = FALSE)
SingleColorGatingSet <- GatingSet(SingleColorCytoSet)

MyGatingTemplate <- gatingTemplate(MyGates)
gt_gating(MyGatingTemplate, SingleColorGatingSet)

SingleColorPlot <- Utility_GatingPlots(x=SingleColorGatingSet[1], 
                                      sample.name = "GUID", 
                                      removestrings = removestrings, 
                                      gtFile = MyGates, 
                                      DesiredGates = NULL, 
                                      outpath = StorageLocation, 
                                      returnType="patchwork")

SingleColorPlot
```

```{r}
plot(SingleColorGatingSet)
```

# Unstained Population Signature 

```{r}
PopulationInterest <- gs_pop_get_data(UnstainedGatingSet, subset="lymphocytes")
TheDataValues <- exprs(PopulationInterest[[1]])
TheDataValues <- data.frame(TheDataValues, check.names=FALSE)
TheSummary <- AveragedSignature(x=TheDataValues, stats="median")
TheData <- TheSummary[,-grep("Time|FS|SC|SS|Original|W$|H$", names(TheSummary))]
TheData <- TheData %>% mutate(Sample="Autofluorescence") %>% relocate(Sample, .before=1)
RawMFIPlot <- Luciernaga::QC_ViewSignature(x="Autofluorescence", data=TheData, Normalize=FALSE, plotlinecolor="royalblue2")

RawMFIPlot
filename <- "RawMFI.png"
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = RawMFIPlot, device="png",
     width = 4, height = 3, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedPlot <- Luciernaga::QC_ViewSignature(x="Autofluorescence",
 data=TheData, Normalize=TRUE,plotlinecolor="red3")
NormalizedPlot
filename <- "NormalizedMFI.png"
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = NormalizedPlot, device="png",
     width = 4, height = 3, units = "in", dpi = 300, bg = "white")
```

Provide a conflict resolution for fluorophores whose primary detectors directly overlap with main detector of the different autofluorescences

```{r}
FileLocation <- system.file("extdata", package = "Luciernaga")
pattern = "AutofluorescentOverlaps.csv"
AFOverlap <- list.files(path=FileLocation, pattern=pattern,
                        full.names = TRUE)
AFOverlap_CSV <- read.csv(AFOverlap, check.names = FALSE)
AFOverlap_CSV
```

Return the general autofluorescence input for subtraction from single colors (if desired)

```{r}
removestrings <- ".fcs"

UnstainedSignatureInput <- Luciernaga_QC(x=UnstainedGatingSet,
                                    subsets="lymphocytes", 
                                    removestrings=removestrings,
                                    sample.name="GUID",
                                    unmixingcontroltype = "cells",
                                    Unstained = TRUE, 
                                    ratiopopcutoff = 0.001,
                                    Verbose = TRUE,
                                    AFOverlap = AFOverlap,
                                    stats = "median",
                                    ExportType = "data.frame",
                                    SignatureReturnNow = TRUE,
                                    outpath = NULL)
```

```{r}
RawSlices <- Luciernaga_LinearSlices(x=UnstainedGatingSet, subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF="V7-A",
                                  titlename="Unstained", legend=FALSE)

RawSlices
filename <- "RawMFIUnstained.png"
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = RawSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
#plotly::ggplotly(RawSlices)
```


```{r}
NormalizedSlices <- Luciernaga_LinearSlices(x=UnstainedGatingSet, subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="normalized",
                                  probsratio=0.1, output="plot", desiredAF="V7-A",
                                  titlename="Unstained (Normalized)")

NormalizedSlices
filename <- "NormalizedMFIUnstained.png"
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = NormalizedSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
#plotly::ggplotly(NormalizedSlices)
```

# BUV615

```{r}
ThisSection <- "BUV615"
ThisDetector <- "UV10-A"
```
```{r}

Cutplot <- Luciernaga_LinearSlices(x=SingleColorGatingSet[1], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection, returncutplot = TRUE)

filename <- paste0(ThisSection, "Cuts.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Cutplot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```


```{r}
RawSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[1], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection)

filename <- paste0(ThisSection, "RawSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = RawSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[1],
 subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
 stats="median", returntype="normalized", probsratio=0.1, output="plot",
 desiredAF=ThisDetector, titlename = paste0(ThisSection, "(Normalized)"))

filename <- paste0(ThisSection, "NormalizedSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = NormalizedSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSliceData <- Luciernaga_LinearSlices(x=SingleColorGatingSet[1],
    subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
    stats="median", returntype="normalized", probsratio=0.1, output="data", desiredAF=ThisDetector)

APCFire810_90to100 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "90")
APCFire810_10to20 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "10")
```

```{r}
NormalizedSliceData <- NormalizedSliceData |> arrange(Percentiles)

CosineData <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="data", rearrange=FALSE)

CosineData

CosinePlot <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="plot", rearrange=FALSE, limitlow=0.8, limithigh=1,
 colorlow="white", colorhigh="mediumorchid2", legend=TRUE)

filename <- paste0(ThisSection, "Cosine.png")
FinalPath <- file.path(StorageLocation, filename)

ggsave(filename = FinalPath, plot = CosinePlot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")

```


Similarity to other fluorophore signatures by cosine value

```{r}
MatchingSignature <- QC_WhatsThis(x="90", data=APCFire810_90to100,
 NumberHits = 6, returnPlots = TRUE)
MatchingSignature[1]
```

```{r}
plotly::ggplotly(MatchingSignature[[2]])
```

```{r}
ContaminationSignature <- QC_WhatsThis(x="10", data=APCFire810_10to20,
 NumberHits = 6, returnPlots = TRUE)
ContaminationSignature[1]
```

```{r}
Amalgamated <- NormalizedSliceData |> mutate(Count=1) |> relocate(Count, .after=Percentiles)

Plot <- QC_Amalgamate(data=Amalgamated, samplecolumn="Percentiles",
 countcolumn="Count", returnType="plot", titlename=NULL, linecolor="red3", legend=FALSE)

filename <- paste0(ThisSection, "Amalgamate.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Plot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
MyPanel <- c("BUV395", "BUV563", "BUV615", "BUV661", "BUV737", "BUV805",
"Pacific Blue", "BV480","BV570", "BV605", "BV650", "BV711", "BV750", "BV786",
"Alexa Fluor 488", "Spark Blue 550", "Spark Blue 574", "RB613", "RB705", "RB780",
"PE", "PE-Dazzle 594", "PE-Cy5", "PE-Fire 700", "PE-Fire 744", "PE-Vio 770", "APC", "Alexa Fluor 647", "Zombie NIR", "APC-R700", "APC-Fire 750", "APC-Fire 810")

HotspotBasePlot <- Luciernaga:::MagesCauldron(panelfluors=MyPanel, unstained=UnstainedSignatureInput)

Brightest <- APCFire810_90to100 |> select(-Sample)
Dimmest <- APCFire810_10to20 |> select(-Sample)

#QC_ReferenceLibrary(FluorNameContains="APC-Fire 810", NumberDetectors = 64)

HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="data", outpath=StorageLocation,
     savePlot=TRUE, filename="BrightHotspot")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="data", savePlot=TRUE, 
     outpath=StorageLocation, filename="DimHotspot")

FileName <- paste0(ThisSection, "HotspotDifference.png")

Difference <- Luciernaga:::TailOfANewt(HotspotBrighter=HotspotBrightest,
 HotspotDimmer=HotspotDimmest,
 savePlot=TRUE, filename=FileName,
 outpath=StorageLocation)


FileName1 <- paste0(ThisSection, "HotspotBrightest.png")

 HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="plot", outpath=StorageLocation,
     savePlot=TRUE, filename=FileName1)

FileName2 <- paste0(ThisSection, "HotspotDimmest.png")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="plot", savePlot=TRUE, 
     outpath=StorageLocation, filename=FileName2)
```

```{r}
print("Goodbye")
```


# BV650

```{r}
ThisSection <- "BV650"
ThisDetector <- "V11-A"
```
```{r}

Cutplot <- Luciernaga_LinearSlices(x=SingleColorGatingSet[2], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection, returncutplot = TRUE)

filename <- paste0(ThisSection, "Cuts.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Cutplot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```


```{r}
RawSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[2], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection)

filename <- paste0(ThisSection, "RawSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = RawSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[2],
 subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
 stats="median", returntype="normalized", probsratio=0.1, output="plot",
 desiredAF=ThisDetector, titlename = paste0(ThisSection, "(Normalized)"))

filename <- paste0(ThisSection, "NormalizedSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = NormalizedSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSliceData <- Luciernaga_LinearSlices(x=SingleColorGatingSet[2],
    subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
    stats="median", returntype="normalized", probsratio=0.1, output="data", desiredAF=ThisDetector)

APCFire810_90to100 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "90")
APCFire810_10to20 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "10")
```

```{r}
NormalizedSliceData <- NormalizedSliceData |> arrange(Percentiles)

CosineData <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="data", rearrange=FALSE)

CosineData

CosinePlot <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="plot", rearrange=FALSE, limitlow=0.8, limithigh=1,
 colorlow="white", colorhigh="mediumorchid2", legend=TRUE)

filename <- paste0(ThisSection, "Cosine.png")
FinalPath <- file.path(StorageLocation, filename)

ggsave(filename = FinalPath, plot = CosinePlot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")

```


Similarity to other fluorophore signatures by cosine value

```{r}
MatchingSignature <- QC_WhatsThis(x="90", data=APCFire810_90to100,
 NumberHits = 6, returnPlots = TRUE)
MatchingSignature[1]
```

```{r}
plotly::ggplotly(MatchingSignature[[2]])
```

```{r}
ContaminationSignature <- QC_WhatsThis(x="10", data=APCFire810_10to20,
 NumberHits = 6, returnPlots = TRUE)
ContaminationSignature[1]
```

```{r}
Amalgamated <- NormalizedSliceData |> mutate(Count=1) |> relocate(Count, .after=Percentiles)

Plot <- QC_Amalgamate(data=Amalgamated, samplecolumn="Percentiles",
 countcolumn="Count", returnType="plot", titlename=NULL, linecolor="red3", legend=FALSE)

filename <- paste0(ThisSection, "Amalgamate.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Plot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
MyPanel <- c("BUV395", "BUV563", "BUV615", "BUV661", "BUV737", "BUV805",
"Pacific Blue", "BV480","BV570", "BV605", "BV650", "BV711", "BV750", "BV786",
"Alexa Fluor 488", "Spark Blue 550", "Spark Blue 574", "RB613", "RB705", "RB780",
"PE", "PE-Dazzle 594", "PE-Cy5", "PE-Fire 700", "PE-Fire 744", "PE-Vio 770", "APC", "Alexa Fluor 647", "Zombie NIR", "APC-R700", "APC-Fire 750", "APC-Fire 810")

HotspotBasePlot <- Luciernaga:::MagesCauldron(panelfluors=MyPanel, unstained=UnstainedSignatureInput)

Brightest <- APCFire810_90to100 |> select(-Sample)
Dimmest <- APCFire810_10to20 |> select(-Sample)

#QC_ReferenceLibrary(FluorNameContains="APC-Fire 810", NumberDetectors = 64)

HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="data", outpath=StorageLocation,
     savePlot=TRUE, filename="BrightHotspot")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="data", savePlot=TRUE, 
     outpath=StorageLocation, filename="DimHotspot")

FileName <- paste0(ThisSection, "HotspotDifference.png")

Difference <- Luciernaga:::TailOfANewt(HotspotBrighter=HotspotBrightest,
 HotspotDimmer=HotspotDimmest,
 savePlot=TRUE, filename=FileName,
 outpath=StorageLocation)


FileName1 <- paste0(ThisSection, "HotspotBrightest.png")

 HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="plot", outpath=StorageLocation,
     savePlot=TRUE, filename=FileName1)

FileName2 <- paste0(ThisSection, "HotspotDimmest.png")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="plot", savePlot=TRUE, 
     outpath=StorageLocation, filename=FileName2)
```

```{r}
print("Goodbye")
```


# BV480

```{r}
ThisSection <- "BV480"
ThisDetector <- "V5-A"
```
```{r}

Cutplot <- Luciernaga_LinearSlices(x=SingleColorGatingSet[3], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection, returncutplot = TRUE)

filename <- paste0(ThisSection, "Cuts.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Cutplot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```


```{r}
RawSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[3], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection)

filename <- paste0(ThisSection, "RawSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = RawSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[3],
 subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
 stats="median", returntype="normalized", probsratio=0.1, output="plot",
 desiredAF=ThisDetector, titlename = paste0(ThisSection, "(Normalized)"))

filename <- paste0(ThisSection, "NormalizedSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = NormalizedSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSliceData <- Luciernaga_LinearSlices(x=SingleColorGatingSet[3],
    subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
    stats="median", returntype="normalized", probsratio=0.1, output="data", desiredAF=ThisDetector)

APCFire810_90to100 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "90")
APCFire810_10to20 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "10")
```

```{r}
NormalizedSliceData <- NormalizedSliceData |> arrange(Percentiles)

CosineData <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="data", rearrange=FALSE)

CosineData

CosinePlot <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="plot", rearrange=FALSE, limitlow=0.8, limithigh=1,
 colorlow="white", colorhigh="mediumorchid2", legend=TRUE)

filename <- paste0(ThisSection, "Cosine.png")
FinalPath <- file.path(StorageLocation, filename)

ggsave(filename = FinalPath, plot = CosinePlot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")

```


Similarity to other fluorophore signatures by cosine value

```{r}
MatchingSignature <- QC_WhatsThis(x="90", data=APCFire810_90to100,
 NumberHits = 6, returnPlots = TRUE)
MatchingSignature[1]
```

```{r}
plotly::ggplotly(MatchingSignature[[2]])
```

```{r}
ContaminationSignature <- QC_WhatsThis(x="10", data=APCFire810_10to20,
 NumberHits = 6, returnPlots = TRUE)
ContaminationSignature[1]
```

```{r}
Amalgamated <- NormalizedSliceData |> mutate(Count=1) |> relocate(Count, .after=Percentiles)

Plot <- QC_Amalgamate(data=Amalgamated, samplecolumn="Percentiles",
 countcolumn="Count", returnType="plot", titlename=NULL, linecolor="red3", legend=FALSE)

filename <- paste0(ThisSection, "Amalgamate.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Plot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
MyPanel <- c("BUV395", "BUV563", "BUV615", "BUV661", "BUV737", "BUV805",
"Pacific Blue", "BV480","BV570", "BV605", "BV650", "BV711", "BV750", "BV786",
"Alexa Fluor 488", "Spark Blue 550", "Spark Blue 574", "RB613", "RB705", "RB780",
"PE", "PE-Dazzle 594", "PE-Cy5", "PE-Fire 700", "PE-Fire 744", "PE-Vio 770", "APC", "Alexa Fluor 647", "Zombie NIR", "APC-R700", "APC-Fire 750", "APC-Fire 810")

HotspotBasePlot <- Luciernaga:::MagesCauldron(panelfluors=MyPanel, unstained=UnstainedSignatureInput)

Brightest <- APCFire810_90to100 |> select(-Sample)
Dimmest <- APCFire810_10to20 |> select(-Sample)

#QC_ReferenceLibrary(FluorNameContains="APC-Fire 810", NumberDetectors = 64)

HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="data", outpath=StorageLocation,
     savePlot=TRUE, filename="BrightHotspot")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="data", savePlot=TRUE, 
     outpath=StorageLocation, filename="DimHotspot")

FileName <- paste0(ThisSection, "HotspotDifference.png")

Difference <- Luciernaga:::TailOfANewt(HotspotBrighter=HotspotBrightest,
 HotspotDimmer=HotspotDimmest,
 savePlot=TRUE, filename=FileName,
 outpath=StorageLocation)


FileName1 <- paste0(ThisSection, "HotspotBrightest.png")

 HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="plot", outpath=StorageLocation,
     savePlot=TRUE, filename=FileName1)

FileName2 <- paste0(ThisSection, "HotspotDimmest.png")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="plot", savePlot=TRUE, 
     outpath=StorageLocation, filename=FileName2)
```

```{r}
print("Goodbye")
```


# PerCP-Cy5.5

```{r}
ThisSection <- "PerCP-Cy55"
ThisDetector <- "B10-A"
```
```{r}

Cutplot <- Luciernaga_LinearSlices(x=SingleColorGatingSet[4], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection, returncutplot = TRUE)

filename <- paste0(ThisSection, "Cuts.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Cutplot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```


```{r}
RawSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[4], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection)

filename <- paste0(ThisSection, "RawSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = RawSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[4],
 subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
 stats="median", returntype="normalized", probsratio=0.1, output="plot",
 desiredAF=ThisDetector, titlename = paste0(ThisSection, "(Normalized)"))

filename <- paste0(ThisSection, "NormalizedSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = NormalizedSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSliceData <- Luciernaga_LinearSlices(x=SingleColorGatingSet[4],
    subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
    stats="median", returntype="normalized", probsratio=0.1, output="data", desiredAF=ThisDetector)

APCFire810_90to100 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "90")
APCFire810_10to20 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "10")
```

```{r}
NormalizedSliceData <- NormalizedSliceData |> arrange(Percentiles)

CosineData <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="data", rearrange=FALSE)

CosineData

CosinePlot <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="plot", rearrange=FALSE, limitlow=0.8, limithigh=1,
 colorlow="white", colorhigh="mediumorchid2", legend=TRUE)

filename <- paste0(ThisSection, "Cosine.png")
FinalPath <- file.path(StorageLocation, filename)

ggsave(filename = FinalPath, plot = CosinePlot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")

```


Similarity to other fluorophore signatures by cosine value

```{r}
MatchingSignature <- QC_WhatsThis(x="90", data=APCFire810_90to100,
 NumberHits = 6, returnPlots = TRUE)
MatchingSignature[1]
```

```{r}
plotly::ggplotly(MatchingSignature[[2]])
```

```{r}
ContaminationSignature <- QC_WhatsThis(x="10", data=APCFire810_10to20,
 NumberHits = 6, returnPlots = TRUE)
ContaminationSignature[1]
```

```{r}
Amalgamated <- NormalizedSliceData |> mutate(Count=1) |> relocate(Count, .after=Percentiles)

Plot <- QC_Amalgamate(data=Amalgamated, samplecolumn="Percentiles",
 countcolumn="Count", returnType="plot", titlename=NULL, linecolor="red3", legend=FALSE)

filename <- paste0(ThisSection, "Amalgamate.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Plot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
MyPanel <- c("BUV395", "BUV563", "BUV615", "BUV661", "BUV737", "BUV805",
"Pacific Blue", "BV480","BV570", "BV605", "BV650", "BV711", "BV750", "BV786",
"Alexa Fluor 488", "Spark Blue 550", "Spark Blue 574", "RB613", "RB705", "RB780",
"PE", "PE-Dazzle 594", "PE-Cy5", "PE-Fire 700", "PE-Fire 744", "PE-Vio 770", "APC", "Alexa Fluor 647", "Zombie NIR", "APC-R700", "APC-Fire 750", "APC-Fire 810")

HotspotBasePlot <- Luciernaga:::MagesCauldron(panelfluors=MyPanel, unstained=UnstainedSignatureInput)

Brightest <- APCFire810_90to100 |> select(-Sample)
Dimmest <- APCFire810_10to20 |> select(-Sample)

#QC_ReferenceLibrary(FluorNameContains="APC-Fire 810", NumberDetectors = 64)

HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="data", outpath=StorageLocation,
     savePlot=TRUE, filename="BrightHotspot")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="data", savePlot=TRUE, 
     outpath=StorageLocation, filename="DimHotspot")

FileName <- paste0(ThisSection, "HotspotDifference.png")

Difference <- Luciernaga:::TailOfANewt(HotspotBrighter=HotspotBrightest,
 HotspotDimmer=HotspotDimmest,
 savePlot=TRUE, filename=FileName,
 outpath=StorageLocation)


FileName1 <- paste0(ThisSection, "HotspotBrightest.png")

 HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="plot", outpath=StorageLocation,
     savePlot=TRUE, filename=FileName1)

FileName2 <- paste0(ThisSection, "HotspotDimmest.png")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="plot", savePlot=TRUE, 
     outpath=StorageLocation, filename=FileName2)
```

```{r}
print("Goodbye")
```


# APC-Fire 810

```{r}
ThisSection <- "APC-Fire 810"
ThisDetector <- "R8-A"
```
```{r}

Cutplot <- Luciernaga_LinearSlices(x=SingleColorGatingSet[5], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection, returncutplot = TRUE)

filename <- paste0(ThisSection, "Cuts.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Cutplot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```


```{r}
RawSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[5], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection)

filename <- paste0(ThisSection, "RawSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = RawSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[5],
 subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
 stats="median", returntype="normalized", probsratio=0.1, output="plot",
 desiredAF=ThisDetector, titlename = paste0(ThisSection, "(Normalized)"))

filename <- paste0(ThisSection, "NormalizedSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = NormalizedSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSliceData <- Luciernaga_LinearSlices(x=SingleColorGatingSet[5],
    subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
    stats="median", returntype="normalized", probsratio=0.1, output="data", desiredAF=ThisDetector)

APCFire810_90to100 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "90")
APCFire810_10to20 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "10")
```

```{r}
NormalizedSliceData <- NormalizedSliceData |> arrange(Percentiles)

CosineData <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="data", rearrange=FALSE)

CosineData

CosinePlot <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="plot", rearrange=FALSE, limitlow=0.8, limithigh=1,
 colorlow="white", colorhigh="mediumorchid2", legend=TRUE)

filename <- paste0(ThisSection, "Cosine.png")
FinalPath <- file.path(StorageLocation, filename)

ggsave(filename = FinalPath, plot = CosinePlot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")

```


Similarity to other fluorophore signatures by cosine value

```{r}
MatchingSignature <- QC_WhatsThis(x="90", data=APCFire810_90to100,
 NumberHits = 6, returnPlots = TRUE)
MatchingSignature[1]
```

```{r}
plotly::ggplotly(MatchingSignature[[2]])
```

```{r}
ContaminationSignature <- QC_WhatsThis(x="10", data=APCFire810_10to20,
 NumberHits = 6, returnPlots = TRUE)
ContaminationSignature[1]
```

```{r}
Amalgamated <- NormalizedSliceData |> mutate(Count=1) |> relocate(Count, .after=Percentiles)

Plot <- QC_Amalgamate(data=Amalgamated, samplecolumn="Percentiles",
 countcolumn="Count", returnType="plot", titlename=NULL, linecolor="red3", legend=FALSE)

filename <- paste0(ThisSection, "Amalgamate.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Plot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
MyPanel <- c("BUV395", "BUV563", "BUV615", "BUV661", "BUV737", "BUV805",
"Pacific Blue", "BV480","BV570", "BV605", "BV650", "BV711", "BV750", "BV786",
"Alexa Fluor 488", "Spark Blue 550", "Spark Blue 574", "RB613", "RB705", "RB780",
"PE", "PE-Dazzle 594", "PE-Cy5", "PE-Fire 700", "PE-Fire 744", "PE-Vio 770", "APC", "Alexa Fluor 647", "Zombie NIR", "APC-R700", "APC-Fire 750", "APC-Fire 810")

HotspotBasePlot <- Luciernaga:::MagesCauldron(panelfluors=MyPanel, unstained=UnstainedSignatureInput)

Brightest <- APCFire810_90to100 |> select(-Sample)
Dimmest <- APCFire810_10to20 |> select(-Sample)

#QC_ReferenceLibrary(FluorNameContains="APC-Fire 810", NumberDetectors = 64)

HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="data", outpath=StorageLocation,
     savePlot=TRUE, filename="BrightHotspot")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="data", savePlot=TRUE, 
     outpath=StorageLocation, filename="DimHotspot")

FileName <- paste0(ThisSection, "HotspotDifference.png")

Difference <- Luciernaga:::TailOfANewt(HotspotBrighter=HotspotBrightest,
 HotspotDimmer=HotspotDimmest,
 savePlot=TRUE, filename=FileName,
 outpath=StorageLocation)


FileName1 <- paste0(ThisSection, "HotspotBrightest.png")

 HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="plot", outpath=StorageLocation,
     savePlot=TRUE, filename=FileName1)

FileName2 <- paste0(ThisSection, "HotspotDimmest.png")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="plot", savePlot=TRUE, 
     outpath=StorageLocation, filename=FileName2)
```

```{r}
print("Goodbye")
```


# BV750

```{r}
ThisSection <- "BV750"
ThisDetector <- "V14-A"
```
```{r}

Cutplot <- Luciernaga_LinearSlices(x=SingleColorGatingSet[6], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection, returncutplot = TRUE)

filename <- paste0(ThisSection, "Cuts.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Cutplot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```


```{r}
RawSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[6], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection)

filename <- paste0(ThisSection, "RawSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = RawSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[6],
 subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
 stats="median", returntype="normalized", probsratio=0.1, output="plot",
 desiredAF=ThisDetector, titlename = paste0(ThisSection, "(Normalized)"))

filename <- paste0(ThisSection, "NormalizedSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = NormalizedSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSliceData <- Luciernaga_LinearSlices(x=SingleColorGatingSet[6],
    subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
    stats="median", returntype="normalized", probsratio=0.1, output="data", desiredAF=ThisDetector)

APCFire810_90to100 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "90")
APCFire810_10to20 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "10")
```

```{r}
NormalizedSliceData <- NormalizedSliceData |> arrange(Percentiles)

CosineData <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="data", rearrange=FALSE)

CosineData

CosinePlot <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="plot", rearrange=FALSE, limitlow=0.8, limithigh=1,
 colorlow="white", colorhigh="mediumorchid2", legend=TRUE)

filename <- paste0(ThisSection, "Cosine.png")
FinalPath <- file.path(StorageLocation, filename)

ggsave(filename = FinalPath, plot = CosinePlot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")

```


Similarity to other fluorophore signatures by cosine value

```{r}
MatchingSignature <- QC_WhatsThis(x="90", data=APCFire810_90to100,
 NumberHits = 6, returnPlots = TRUE)
MatchingSignature[1]
```

```{r}
plotly::ggplotly(MatchingSignature[[2]])
```

```{r}
ContaminationSignature <- QC_WhatsThis(x="10", data=APCFire810_10to20,
 NumberHits = 6, returnPlots = TRUE)
ContaminationSignature[1]
```

```{r}
Amalgamated <- NormalizedSliceData |> mutate(Count=1) |> relocate(Count, .after=Percentiles)

Plot <- QC_Amalgamate(data=Amalgamated, samplecolumn="Percentiles",
 countcolumn="Count", returnType="plot", titlename=NULL, linecolor="red3", legend=FALSE)

filename <- paste0(ThisSection, "Amalgamate.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Plot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
MyPanel <- c("BUV395", "BUV563", "BUV615", "BUV661", "BUV737", "BUV805",
"Pacific Blue", "BV480","BV570", "BV605", "BV650", "BV711", "BV750", "BV786",
"Alexa Fluor 488", "Spark Blue 550", "Spark Blue 574", "RB613", "RB705", "RB780",
"PE", "PE-Dazzle 594", "PE-Cy5", "PE-Fire 700", "PE-Fire 744", "PE-Vio 770", "APC", "Alexa Fluor 647", "Zombie NIR", "APC-R700", "APC-Fire 750", "APC-Fire 810")

HotspotBasePlot <- Luciernaga:::MagesCauldron(panelfluors=MyPanel, unstained=UnstainedSignatureInput)

Brightest <- APCFire810_90to100 |> select(-Sample)
Dimmest <- APCFire810_10to20 |> select(-Sample)

#QC_ReferenceLibrary(FluorNameContains="APC-Fire 810", NumberDetectors = 64)

HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="data", outpath=StorageLocation,
     savePlot=TRUE, filename="BrightHotspot")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="data", savePlot=TRUE, 
     outpath=StorageLocation, filename="DimHotspot")

FileName <- paste0(ThisSection, "HotspotDifference.png")

Difference <- Luciernaga:::TailOfANewt(HotspotBrighter=HotspotBrightest,
 HotspotDimmer=HotspotDimmest,
 savePlot=TRUE, filename=FileName,
 outpath=StorageLocation)


FileName1 <- paste0(ThisSection, "HotspotBrightest.png")

 HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="plot", outpath=StorageLocation,
     savePlot=TRUE, filename=FileName1)

FileName2 <- paste0(ThisSection, "HotspotDimmest.png")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="plot", savePlot=TRUE, 
     outpath=StorageLocation, filename=FileName2)
```

```{r}
print("Goodbye")
```


# PE

```{r}
ThisSection <- "PE"
ThisDetector <- "YG1-A"
```
```{r}

Cutplot <- Luciernaga_LinearSlices(x=SingleColorGatingSet[7], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection, returncutplot = TRUE)

filename <- paste0(ThisSection, "Cuts.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Cutplot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```


```{r}
RawSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[7], subset="lymphocytes",
                                  sample.name="GUID", removestrings=removestrings,
                                  stats="median", returntype="raw",
                                  probsratio=0.1, output="plot", desiredAF=ThisDetector,
                                  titlename = ThisSection)

filename <- paste0(ThisSection, "RawSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = RawSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSlices <- Luciernaga_LinearSlices(x=SingleColorGatingSet[7],
 subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
 stats="median", returntype="normalized", probsratio=0.1, output="plot",
 desiredAF=ThisDetector, titlename = paste0(ThisSection, "(Normalized)"))

filename <- paste0(ThisSection, "NormalizedSlices.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = NormalizedSlices, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
NormalizedSliceData <- Luciernaga_LinearSlices(x=SingleColorGatingSet[7],
    subset="lymphocytes", sample.name="GUID", removestrings=removestrings,
    stats="median", returntype="normalized", probsratio=0.1, output="data", desiredAF=ThisDetector)

APCFire810_90to100 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "90")
APCFire810_10to20 <- NormalizedSliceData |> rename(Sample = Percentiles) |>
     dplyr::filter(Sample %in% "10")
```

```{r}
NormalizedSliceData <- NormalizedSliceData |> arrange(Percentiles)

CosineData <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="data", rearrange=FALSE)

CosineData

CosinePlot <- Luciernaga_Cosine(data=NormalizedSliceData,
 returntype="plot", rearrange=FALSE, limitlow=0.8, limithigh=1,
 colorlow="white", colorhigh="mediumorchid2", legend=TRUE)

filename <- paste0(ThisSection, "Cosine.png")
FinalPath <- file.path(StorageLocation, filename)

ggsave(filename = FinalPath, plot = CosinePlot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")

```


Similarity to other fluorophore signatures by cosine value

```{r}
MatchingSignature <- QC_WhatsThis(x="90", data=APCFire810_90to100,
 NumberHits = 6, returnPlots = TRUE)
MatchingSignature[1]
```

```{r}
plotly::ggplotly(MatchingSignature[[2]])
```

```{r}
ContaminationSignature <- QC_WhatsThis(x="10", data=APCFire810_10to20,
 NumberHits = 6, returnPlots = TRUE)
ContaminationSignature[1]
```

```{r}
Amalgamated <- NormalizedSliceData |> mutate(Count=1) |> relocate(Count, .after=Percentiles)

Plot <- QC_Amalgamate(data=Amalgamated, samplecolumn="Percentiles",
 countcolumn="Count", returnType="plot", titlename=NULL, linecolor="red3", legend=FALSE)

filename <- paste0(ThisSection, "Amalgamate.png")
FinalPath <- file.path(StorageLocation, filename)
ggsave(filename = FinalPath, plot = Plot, device="png",
     width = 6, height = 4, units = "in", dpi = 300, bg = "white")
```

```{r}
MyPanel <- c("BUV395", "BUV563", "BUV615", "BUV661", "BUV737", "BUV805",
"Pacific Blue", "BV480","BV570", "BV605", "BV650", "BV711", "BV750", "BV786",
"Alexa Fluor 488", "Spark Blue 550", "Spark Blue 574", "RB613", "RB705", "RB780",
"PE", "PE-Dazzle 594", "PE-Cy5", "PE-Fire 700", "PE-Fire 744", "PE-Vio 770", "APC", "Alexa Fluor 647", "Zombie NIR", "APC-R700", "APC-Fire 750", "APC-Fire 810")

HotspotBasePlot <- Luciernaga:::MagesCauldron(panelfluors=MyPanel, unstained=UnstainedSignatureInput)

Brightest <- APCFire810_90to100 |> select(-Sample)
Dimmest <- APCFire810_10to20 |> select(-Sample)

#QC_ReferenceLibrary(FluorNameContains="APC-Fire 810", NumberDetectors = 64)

HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="data", outpath=StorageLocation,
     savePlot=TRUE, filename="BrightHotspot.png")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="data", savePlot=TRUE, 
     outpath=StorageLocation, filename="DimHotspot")

FileName <- paste0(ThisSection, "HotspotDifference.png")

Difference <- Luciernaga:::TailOfANewt(HotspotBrighter=HotspotBrightest,
 HotspotDimmer=HotspotDimmest,
 savePlot=TRUE, filename=FileName,
 outpath=StorageLocation)


FileName1 <- paste0(ThisSection, "HotspotBrightest.png")

 HotspotBrightest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Brightest, returnType="plot", outpath=StorageLocation,
     savePlot=TRUE, filename=FileName1)

FileName2 <- paste0(ThisSection, "HotspotDimmest.png")

HotspotDimmest <- Luciernaga:::MagesCauldron(panelfluors=MyPanel,
     unstained=UnstainedSignatureInput, swapname=ThisSection,
     swapvalue=Dimmest, returnType="plot", savePlot=TRUE, 
     outpath=StorageLocation, filename=FileName2)
```

```{r}
print("Goodbye")
```




